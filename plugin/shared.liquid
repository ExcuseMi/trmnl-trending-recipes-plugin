{% template main %}
{% assign show_summary = trmnl.plugin_settings.custom_fields_values.show_summary | default: "true" %}
<div class="layout layout--stretch">
  <div class="columns" data-overflow-max-cols="{{columns}}">
    <div class="column">
      {% assign sections = "user,global" | split: "," %}
      {% for section in sections %}

        {% if section == "user" %}
          {% unless user_recipes %}{% continue %}{% endunless %}
          {% if show_summary == "true" and user_stats %}
          <span class="label label--medium" data-group-header="true">My Developer Summary</span>
          <div class="item">
            <div class="flex gap w--full">
              <div class="item stat-col">
                <div class="meta"></div>
                <div class="content">
                  <span class="value value--xxsmall" data-value-fit="true" data-fmt-number>{{ user_stats.total_popularity }}</span>
                  <span class="label label--small">connections</span>
                </div>
              </div>
              <div class="item stat-col">
                <div class="meta"></div>
                <div class="content">
                  {% assign us_delta = user_stats.popularity_delta | default: 0 %}
                  {% if us_delta > 0 %}
                  <span class="value value--xxsmall" data-value-fit="true">+<span data-fmt-number>{{ us_delta }}</span></span>
                  <span class="label label--small">gained</span>
                  {% elsif us_delta < 0 %}
                  <span class="value value--xxsmall" data-value-fit="true">-<span data-fmt-number>{{ us_delta | abs }}</span></span>
                  <span class="label label--small">lost</span>
                  {% else %}
                  <span class="value value--xxsmall">--</span>
                  <span class="label label--small">change</span>
                  {% endif %}
                </div>
              </div>
              {% if user_stats.developer_rank %}
              <div class="item stat-col">
                <div class="meta"></div>
                <div class="content">
                  <span class="value value--xxsmall" data-value-fit="true">#{{ user_stats.developer_rank }}</span>
                  <span class="label label--small">of {{ global_stats.total_developers }} devs</span>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          <span class="label label--medium" data-group-header="true">My Recipes</span>
          {% assign items = user_recipes %}
        {% else %}
          {% if user_recipes %}
          <span class="label label--medium" data-group-header="true">Trending</span>
          {% endif %}
          {% assign items = recipes %}
        {% endif %}

        {% for recipe in items %}
        {% assign delta = recipe.popularity_delta | default: 0 %}
        {% assign delta_abs = delta | abs %}
        {% assign total_popularity = recipe.popularity | default: 0 %}
        {% assign recipe_age_days = recipe.recipe_age_days %}
        {% if recipe_age_days == nil or recipe_age_days == blank %}
        {% assign is_new_recipe = false %}
        {% else %}
        {% if recipe_age_days <= 7 %}
          {% assign is_new_recipe = true %}
          {% else %}
          {% assign is_new_recipe = false %}
          {% endif %}
          {% endif %}
          {% assign rank_diff = recipe.rank_difference %}
          {% assign current_rank = recipe.global_rank | default: 0 %}
          <div class="item {% if recipe.is_top_gainer %}item--emphasis-3 {% elsif section == "user" %}item--emphasis-2 {% endif %}{% if forloop.last %} item--group-last{% endif %}">
            <div class="meta"></div>
            <div class="icon self--start m--0">
            <img class="image w--8 h--8" src="{% if recipe.icon_url %}{{recipe.icon_url}}{% else %}https://trmnl.com/images/plugins/trmnl--render.svg{% endif %}" onerror="this.onerror=null;this.src='https://trmnl.com/images/plugins/trmnl--render.svg';" />
            </div>
            <div class="content pl--1 self--start">
              <div class="title title--small" data-value-fit="true" data-clamp="2">
                {{ recipe.name }}
              </div>
              <div class="label">#{{ current_rank }}{% if rank_diff != null and rank_diff > 0 %}
                <span class="label label--gray ml--2">▲  {{ rank_diff }}</span>{% elsif rank_diff != null and rank_diff < 0 %}{% assign rank_diff_abs = rank_diff | abs %}
                <span class="label label--gray ml--2">▼  {{ rank_diff_abs }}</span>{% endif %}</div>
            </div>
            <div class="flex flex--col w--auto gap--none self--start w--min-14 delta-col">
              {% if delta > 0 %}
              <div class="label label--inverted w--full label--center" data-value-fit="true">
<svg class="w--4 h--4 mr--1" fill="#ffffff" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"><path d="M38 26V2H26v24H2v12h24v24h12V38h24V26z"></path></svg>
{{ delta_abs }}</div>
              <div class="label label--outline w--full label--center"><span data-fmt-number>{{ total_popularity }}</span></div>
              {% elsif delta < 0 %}
              <div class="label label--outline w--full label--center" data-value-fit="true"><span data-fmt-number>{{ total_popularity }}</span></div>
              <div class="label label--inverted w--full label--center" data-value-fit="true">
              <svg class="w--4 h--4 mr--1" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="10" width="16" height="4" rx="1"/>
              </svg>
               {{ delta_abs }}</div>
              {% else %}
              <div class="label label--outline w--full label--center"><span data-fmt-number>{{ total_popularity }}</span></div>
              {% endif %}
            </div>
          </div>
        {% endfor %}

      {% endfor %}

    </div>
  </div>
</div>
<div class="title_bar">
    <svg class="w--7 h--7 image-stroke" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M5.5 5V19.5H20M7.5 16L11.5 11.5L15.5 14L19.5 8.5" stroke="#000000" stroke-width="1.2"/>
    </svg>
  <div class="title">{{trmnl.plugin_settings.instance_name}}
  </div>
  <div class="instance">
    {% assign tf = trmnl.plugin_settings.custom_fields_values.timeframe | default: "24h" %}
    {% case tf %}
      {% when "today" %}Today
      {% when "24h" %}Last 24 Hours
      {% when "3d" %}Last 3 Days
      {% when "7d" %}Last 7 Days
      {% when "30d" %}Last 30 Days
      {% else %}{{ tf | upcase }}
    {% endcase %}
  </div>
</div>
<style>
.delta-col { align-items: stretch; margin-left: auto; }
.label--center { justify-content: center; }
.stat-col { flex: 1; }
</style>
<script>
function fmtNum(n) {
  var a = Math.abs(n);
  if (a >= 1000) {
    var w = Math.floor(a / 1000);
    var r = Math.floor((a % 1000) / 100);
    return r === 0 ? w + 'k' : w + '.' + r + 'k';
  }
  return '' + a;
}
document.querySelectorAll('[data-fmt-number]').forEach(function(el) {
  var n = parseInt(el.textContent, 10);
  if (!isNaN(n)) el.textContent = fmtNum(n);
});
</script>
{% endtemplate %}
