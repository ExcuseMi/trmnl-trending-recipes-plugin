<div class="layout layout--stretch">
  <div class="columns" data-overflow-max-cols="3">
    <div class="column">

      {% assign sections = "user,global" | split: "," %}
      {% for section in sections %}

        {% if section == "user" %}
          {% unless user_recipes %}{% continue %}{% endunless %}
          <span class="label label--medium" data-group-header="true">My Recipes{% if user_stats %} · {{ user_stats.total_popularity }}{% assign us_delta = user_stats.popularity_delta | default: 0 %}{% if us_delta > 0 %} (+{{ us_delta }}){% elsif us_delta < 0 %} ({{ us_delta }}){% endif %}{% endif %}</span>
          {% assign items = user_recipes %}
        {% else %}
          {% if user_recipes %}
          <span class="label label--medium" data-group-header="true">Trending</span>
          {% endif %}
          {% assign items = recipes %}
        {% endif %}

        {% for recipe in items %}
        {% assign delta = recipe.popularity_delta | default: 0 %}
        {% assign delta_abs = delta | abs %}
        {% assign total_popularity = recipe.popularity | default: 0 %}
        {% if total_popularity >= 1000 %}
          {% assign pop_k = total_popularity | divided_by: 100 %}
          {% assign pop_remainder = pop_k | modulo: 10 %}
          {% assign pop_whole = pop_k | divided_by: 10 %}
          {% if pop_remainder == 0 %}
            {% capture pop_display %}{{ pop_whole }}k{% endcapture %}
          {% else %}
            {% capture pop_display %}{{ pop_whole }}.{{ pop_remainder }}k{% endcapture %}
          {% endif %}
        {% else %}
          {% assign pop_display = total_popularity %}
        {% endif %}
        {% assign recipe_age_days = recipe.recipe_age_days %}
        {% if recipe_age_days == nil or recipe_age_days == blank %}
        {% assign is_new_recipe = false %}
        {% else %}
        {% if recipe_age_days <= 7 %}
          {% assign is_new_recipe = true %}
          {% else %}
          {% assign is_new_recipe = false %}
          {% endif %}
          {% endif %}
          {% assign rank_diff = recipe.rank_difference %}
          {% assign current_rank = recipe.global_rank | default: 0 %}

          <div class="item">
            <div class="icon self--start">
            <img class="image w--10 h--10" src="{% if recipe.icon_url %}{{recipe.icon_url}}{% else %}https://trmnl.com/images/plugins/trmnl--render.svg{% endif %}" />
            </div>
            <div class="content pl--1 self--start">
              <div class="title title--small" data-clamp="1">
                {{ recipe.name }}
              </div>
              <div class="label">#{{ current_rank }}{% if rank_diff != null and rank_diff > 0 %} <span class="label label--gray" title="Rank improved by {{ rank_diff }} positions">▲{{ rank_diff }}</span>{% elsif rank_diff != null and rank_diff < 0 %}{% assign rank_diff_abs = rank_diff | abs %} <span class="label label--gray" title="Rank dropped by {{ rank_diff_abs }} positions">▼{{ rank_diff_abs }}</span>{% endif %}</div>
            </div>
            <div class="flex flex--col w--auto gap--none" style="align-items:stretch;margin-left:auto;">
              {% if delta > 0 %}
              <div class="label label--inverted w--full" style="justify-content:center;" data-value-fit="true" title="Gained {{ delta_abs }} popularity">▲ {{ delta_abs }}</div>
              <div class="label label--outline w--full" style="justify-content:center;" title="Total popularity: {{ total_popularity }}">{{ pop_display }}</div>
              {% elsif delta < 0 %}
              <div class="label label--outline w--full" style="justify-content:center;" data-value-fit="true" title="Total popularity: {{ total_popularity }}">{{ pop_display }}</div>
              <div class="label label--inverted w--full" style="justify-content:center;" data-value-fit="true" title="Lost {{ delta_abs }} popularity">▼ {{ delta_abs }}</div>
              {% else %}
              <div class="label label--outline w--full" style="justify-content:center;" title="Total popularity: {{ total_popularity }}">{{ pop_display }}</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}

      {% endfor %}

    </div>
  </div>
</div>
<div class="title_bar">
  <img class="image" src="https://trmnl.com/images/plugins/trmnl--render.svg" />
  <div class="title">{{trmnl.plugin_settings.instance_name}}
  </div>
  <div class="instance" title="Time period for trending calculation">
    {% assign tf = trmnl.plugin_settings.custom_fields_values.timeframe | default: "24h" %}
    {% case tf %}
      {% when "today" %}Today
      {% when "24h" %}Last 24 Hours
      {% when "3d" %}Last 3 Days
      {% when "7d" %}Last 7 Days
      {% when "30d" %}Last 30 Days
      {% else %}{{ tf | upcase }}
    {% endcase %}
  </div>
</div>
<script />
